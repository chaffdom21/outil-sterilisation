<!DOCTYPE html>
<html lang="fr">


<head>
    <meta charset="UTF-8" />
    <title>Outil — Registre de stérilisation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css"/>


    <style>





        .logo img {
            box-shadow: none !important;
            filter: none !important;
            background: none !important;

        }
        /* Embed key tool styles to keep it portable */
        :root {
            --primary: #11548e;
            --primary-dark: #005fa3;
        }
        }
        body.tool { background: linear-gradient(180deg,#0a0f1f, #0b1430); }
        .container { padding: 20px; }
        .header-band { background-color: var(--primary); padding: 10px 0; color:#fff; }
        .header-band h1 { margin: 6px 0 0 30px; line-height:1.2; }
        .bande-sous { background-color: #1b1c30; padding: 8px 12px; text-align:center; color: #bec5dd; }
        h2 { font-size: 20px; margin-bottom: 8px; color: #bdc3dc; }
        h3 { font-size: 16px; margin: 15px 0 4px; color:#444; }
        h5 { font-size: 13px; font-weight: normal; color:#666; margin: 0 0 8px; }
        .input-area { margin: 12px 0; display:flex; gap:18px; flex-wrap:wrap; align-items:center; }
        .field { display:flex; align-items:center; gap:8px; }
        .field label {font-weight:600; white-space:nowrap; }
        .input-text { padding: 10px 12px; font-size: 16px; border:1px solid #bbb; border-radius: 8px; }
        .input-text:focus { border-color: var(--primary); box-shadow: 0 0 4px rgba(0,119,204,.25); outline:none; }
        #date.input-text{ width: 140px; }
        #code.input-text{ width: 160px; }
        .table-wrap { width:100%; overflow-x:auto; border-radius: 8px; }
        table { min-width:720px; width:100%; border-collapse:collapse; margin-top: 0px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); background: #ffffff; }
        thead th { background: var(--primary); color:#fff; font-weight:600; text-align:center; padding:10px;}
        thead tr:first-child th { background: var(--primary-dark); }
        td, th { border:1px solid #bbc2d8; padding:20px; text-align:center; }
        tbody td:first-child { text-align:left; font-weight:600; background: #ffffff;}
        input[type="checkbox"] { transform: scale(1.3); cursor:pointer; accent-color: var(--primary); }
        .echec { margin-top:16px; background:#f7f9ff; border-left:4px solid var(--primary); padding:8px 12px; border-radius:6px; }
        .question1 { margin:8px 0 20px; display:flex; flex-direction:column; gap:8px;  }
        .question1 label { font-weight:3000;}
        .question2 label {font-weight:3000; color: #0077cc; }
        .questionbox { min-height: 100px; padding:10px; border:1px solid #ffffff; border-radius:5px; font-size:16px; }
        .actions { display:flex; gap:10px; flex-wrap:wrap; margin:16px 0 24px; }
        .btn {
            appearance:none; border:0; background: var(--primary); color:#fff; padding:12px 16px; border-radius:10px;
            font-size:16px; font-weight:600; cursor:pointer; box-shadow:0 6px 16px rgba(0,119,204,.25);
        }
        .btn.secondary { background:#111; }
        .hint { font-size:12px; color:#666; }
        @media (max-width:600px){
            #date.input-text{ width: 120px; }
            #code.input-text{ width: 140px; }
            td, th { padding: 8px; }
            .btn { width:100%; }
        }
        .question2 {
            margin:8px 0 20px;
            display:flex;
            flex-direction:column;
            gap:8px;
            color: #45e49c !important;
        }
        .question2 label { font-weight:600;}
        .question-box { min-height: 100px; padding:10px; border:1px solid #ffffff; border-radius:5px; font-size: 16px; }

        .question3 {
            margin:8px 0 20px;
            display:flex;
            flex-direction:column;
            gap:8px;
        }
        .question_box {
            min-height: 350px;
            padding:10px;
            border:1px solid #424242;
            border-radius:5px;
            font-size: 16px;
        }


        @media print {
            .actions, .hint { display:none !important; }
            .table-wrap { overflow:visible; }
            table { box-shadow:none; background:#fff; }
            .header-band, .bande-sous { -webkit-print-color-adjust:exact; print-color-adjust:exact; }
        }
        .table-wrap {
            width: 100%;
            overflow-x: auto;
            border-radius: 8px;
            margin-bottom: 20px;
            margin-top: 25px;
        }

        .titre-echec {
            font-size: 1.4rem;
            font-family: Arial, sans-serif;
            letter-spacing: 1.5px;
            color: #fff;
            margin: 0;
            padding: 8px 0;
        }
        .deuxieme-bande {
            background: #005fa3;
            text-align: center;
            border-radius: 8px;
            margin: 30px 0 20px;
            padding: 12px;
        }
        .troixieme-bande {
            background: #005fa3;
            text-align: center;
            border-radius: 8px;
            margin: 30px 0 20px;
            padding: 12px;
            margin-top: 40px;
        }


        /* Contrast fixes: force dark text within the tool block sitting on dark site background */
        .tool table, .tool td, .tool th { color: #efefef !important; }
        .tool tbody td:first-child { color: #000000 !important; }
        .tool .field label { color:#111 !important; }
        .tool .question1 label { color: #000000 !important; }
        .tool .question2 label { color: #ececec !important; }
        .tool .questionbox { color: #0b0b0b !important; background:#fff; }
        .tool h3, .tool h5 { color:#222 !important; }
        .tool .question3 label { color: #e3e3e3 !important; }

        /* Make legend texts white for visibility */
        .tool h3, .tool h5 { color: #f3f3f3 !important;}


        /* Legend styling for readability */
        .legend{ background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12); padding:10px 12px; border-radius:10px; margin:10px 0 6px 0; }
        .legend h3, .legend h5 { color:#fff !important; margin: 4px 0; }


        /* Force Date/Code labels + inputs to black text */
        .tool .field label { color: #000000 !important; }
        .tool .input-text { color:#111 !important; background:#fff !important; }


        /* Inputs + placeholders in black for readability */
        .tool .input-text { color:#111 !important; background:#fff !important; }
        .tool .input-text::placeholder { color: #505050 !important; opacity:0.8; }
        /* Ensure field labels are black as well */
        .tool .field label { color:#111 !important; }



        /* FINAL input color fix */
        .tool body, .tool form, .tool input, .tool textarea { color:#111 !important; }
        .tool .input-text, .tool .questionbox { color:#111 !important; background: #dddddd !important; }
        .tool .input-text::placeholder, .tool .questionbox::placeholder { color: #707070 !important; opacity:1 !important; }
        .tool .field label { color:#111 !important; }


        /* Force labels to white for clarity on dark background */
        .tool .field label,
        .tool .question1 label {
            color: #6c6c6c !important;
        }


        /* Date triplet fields */
        .tool .input-yr{ width:90px !important; text-align:center; }
        .tool .input-mm,.tool .input-dd{ width:70px !important; text-align:center; }
        /* Visual slash separators should be lighter on dark background */
        .tool #date-group span{ color:#cfd7ef !important;  }


        /* --- Tool mobile enhancements --- */
        @media (max-width: 640px){
            .tool .input-text { padding: 12px 14px; font-size: 18px; border-radius: 12px; }
            .tool .questionbox { min-height: 140px; font-size: 18px; border-radius: 12px; }
            .tool .btn { padding: 14px 18px; border-radius: 14px; font-weight: 700; }
            .tool .actions { gap: 12px; }
            .tool table { min-width: 680px; }
            .tool .table-wrap { position: relative; -webkit-overflow-scrolling: touch; }
            .tool .table-wrap::after {
                content: 'Glissez →';
                position: absolute; right: 10px; top: -28px;
                font-size: 12px; color: #cfe2ff; opacity: .9;
                background: rgba(0,0,0,.25); padding: 4px 8px; border-radius: 999px;
            }
            .tool tbody td:first-child, .tool thead th:first-child {
                position: sticky; left: 0; z-index: 1; background: #f4f6f8;
            }
        }


        /* Toast default style tweak for mobile safe area */
        @media (max-width: 640px){
            .tool .toast { bottom: calc(18px + env(safe-area-inset-bottom)); }
        }

        /* Section des questions */
        .questions-section {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2 colonnes */
            gap: 20px; /* espace entre les blocs */
            margin-top: 30px;
        }

        /* Chaque question */
        .questions-section .field {
            display: flex;
            flex-direction: column;
            background: #f9f9f9; /* fond doux */
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        /* Titres (labels) */
        .questions-section .field label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #222; /* bien lisible */
            font-size: 0.95rem;
        }

        /* Zone de texte */
        .questions-section .field textarea {
            resize: vertical; /* permet d’agrandir verticalement */
            min-height: 60px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-family: inherit;
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        /* Effet focus quand on clique dedans */
        .questions-section .field textarea:focus {
            border-color: #005fa3;
            box-shadow: 0 0 4px rgba(0,95,163,0.3);
            outline: none;
        }

        /* Responsive : sur mobile (moins de 700px) */
        @media (max-width: 700px) {
            .questions-section {
                grid-template-columns: 1fr; /* une seule colonne */
            }
        }
        .table-actions {
            padding-bottom: 30px;
        }

        button {
            box-shadow: none !important;
        }

        body {
            margin: 0;
            background: linear-gradient(135deg, #063053, #000000);
            color: #fff;
            font-family: Arial, sans-serif;
        }

        .header-band{
            background: linear-gradient(135deg, #063053, #000000);
            color: #fff;
        }

        .bande-sous{
            background: linear-gradient(135deg, #2f80cd, #213380);
            color: #fff;
        }

        .header-band, .bande-sous, .deuxieme-bande, .troixieme-bande {
            opacity: 0;
            transform: translateY(-20px);
            animation: slideFadeIn 0.8s forwards;
        }

        .header-band { animation-delay: 0.1s; }
        .bande-sous { animation-delay: 0.4s; }
        .deuxieme-bande { animation-delay: 0.7s; }
        .troixieme-bande { animation-delay: 1s; }

        @keyframes slideFadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .underlined-title {
            display: inline-block;       /* So the underline matches the text width */
            border-bottom: 3px solid #00bfff; /* Color and thickness of the underline */
            padding-bottom: 4px;         /* Space between text and underline */
        }

        .codeDuSteri
        {
            color: #ffffff;
        }

        #date-group input {
            width: 20px;       /* largeur des cases AAAA / MM / JJ */
            height: 25px;      /* hauteur des cases */
            font-size: 80%;    /* texte à l’intérieur */
            padding: 2px 4px;  /* espace interne (haut/bas, gauche/droite) */
        }

        .codeDuSteri input {
            width: 90px !important;      /* largeur du champ */
            height: 30px;      /* hauteur */
            font-size: 80%;
            padding: 2px 4px;
        }


    </style>
</head>



<body class="tool">
<main>



    <div class="header-band">
        <div class="container header-inner" style="display:flex;align-items:center;justify-content:space-between;">
            <h1  style=;font-size:1.8rem;font-family:'arial', sans-serif">LES REGISTRES EXIGÉS</h1>
            <nav class="nav" style="display:flex;gap:20px;">
                <a href="contact.html" style="padding:11px 30px;background:#012e50;color:#fff;border-radius:6px;text-decoration:none;margin-right:auto;">Contact</a>
            </nav>
        </div>

    </div>


    <div class="bande-sous">
        <h1 style="font-size:1.3rem;margin:6px 0">Registre du stérilisateur</h1>
    </div>

    <div class="container">
        <div class="legend">
            <h3>Légende:</h3>
            <h5>IC = indicateur chimique | IB = indicateur biologique | DPE = dispositif de procédé d'essai</h5>
        </div>


        <form id="steri-form">
            <div class="input-area" style="padding-top: 25px;">
                <div class="field" id="date-group">
                    <label for="dateY" style="color: #ffffff !important; font-size: 80%;" >Date (année/mois/jour) :</label>
                    <input id="dateY" type="text" class="input-text input-yr" inputmode="numeric" pattern="\d{4}" maxlength="4" placeholder="AAAA" />
                    <span style="margin:0 6px;color:#888">/</span>
                    <input id="dateM" type="text" class="input-text input-mm" inputmode="numeric" pattern="\d{1,2}" maxlength="2" placeholder="MM" />
                    <span style="margin:0 6px;color:#888">/</span>
                    <input id="dateD" type="text" class="input-text input-dd" inputmode="numeric" pattern="\d{1,2}" maxlength="2" placeholder="JJ" />
                </div>

                <div class="codeDuSteri" style="margin-left:auto; padding-left:0; text-align:right; padding-top: 0px; font-size: 80%;">
                    <label for="code">Code du stérilisateur :</label>
                    <input id="code" type="text" class="input-text" placeholder="" />
                </div>
            </div>



            <div class="table-wrap">
                <table id="grid">
                    <thead>
                    <tr>
                        <th rowspan="2">Paramètres</th>
                        <th colspan="8">Numéro de la charge</th>
                    </tr>
                    <tr>
                        <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>Vérification de paramètres physiques</td>
                        <td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td>
                        <td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td>
                    </tr>
                    <tr>
                        <td>Vérification de l’IC de type 1 de chaque paquet</td>
                        <td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td>
                        <td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td>
                    </tr>
                    <tr>
                        <td>Vérification de l’IC de type 4 de chaque paquet</td>
                        <td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td>
                        <td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td>
                    </tr>
                    <tr>
                        <td>Vérification du DPE avec IC de type 5 de la charge</td>
                        <td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td>
                        <td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td>
                    </tr>
                    <tr>
                        <td>DPE avec IB et IC de type 5</td>
                        <td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td>
                        <td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td>
                    </tr>
                    <tr>
                        <td>DPE avec IC de type 2</td>
                        <td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td>
                        <td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="table-actions" style="margin: 15px 0; display: flex; gap: 10px;">
                <button type="button" class="btn" onclick="ajouterColonne()">+ Ajouter une charge</button>
                <button type="button" class="btn secondary" onclick="supprimerColonne()">– Supprimer la dernière charge</button>
            </div>


            <div class="deuxieme-bande">
                <h2 class="titre-echec">REGISTRE DES ÉCHECS DE STÉRILISATION</h2>
            </div>

            <div class="container">
                <!-- contenu formulaire -->
            </div>


            <div class="question1">
                <label for="q1" style="font-weight: bold; color: #ffffff !important;">Type d’échec (IB, PP, IC de type 1, 2, 3, 4 ou 5)</label>
                <textarea id="q1" class="question-box" placeholder="Réponse ici..." "></textarea>
            </div>

            <div class="question2">
                <label for="dm" style="color: #ffffff !important;">Liste et quantité des DM rappelés :</label>
                <textarea id="dm" class="question-box" placeholder="Réponse ici..."></textarea>
            </div>

            <div class="question3">
                <label for="resolution" style="color: #ffffff !important; font-weight: bold;">Résolution du problème :</label>
                <textarea id="resolution" class="question_box" placeholder="Réponse ici..."></textarea>
            </div>




            <div class="troixieme-bande">
                <h2 class="titre-echec">REGISTRE DES CYCLES NON EMBALLÉS</h2>
            </div>


            <div class="questions-section">
                <!-- Question 4 -->
                <div class="field question-4">
                    <label for="question-4">Numéro de la charge :</label>
                    <textarea id="question-4" placeholder="Réponse ici"></textarea>
                </div>

                <!-- Question 5 -->
                <div class="field question-5">
                    <label for="question-5">Nom du patient :</label>
                    <textarea id="question-5" placeholder="Réponse ici"></textarea>
                </div>

                <!-- Question 6 -->
                <div class="field question-6">
                    <label for="question-6">Procédure dentaire réalisée :</label>
                    <textarea id="question-6" placeholder="Réponse ici"></textarea>
                </div>

                <!-- Question 7 -->
                <div class="field question-7">
                    <label for="question-7">Nom du professionnel :</label>
                    <textarea id="question-7" placeholder="Réponse ici"></textarea>
                </div>

                <!-- Question 8 -->
                <div class="field question-8">
                    <label for="question-8">DM utilisés :</label>
                    <textarea id="question-8" placeholder="Réponse ici"></textarea>
                </div>

                <!-- Question 9 -->
                <div class="field question-9">
                    <label for="question-9">Vérification des PP et DPE avec IC de type 5 :</label>
                    <textarea id="question-9" placeholder="Réponse ici"></textarea>
                </div>
            </div>




            <div class="actions">
                <button type="submit" class="btn">Soumettre & Télécharger en Word</button>
                <button type="button" class="btn secondary" onclick="window.print()">Imprimer / PDF</button>
            </div>
        </form>
    </div>
</main>




<!-- docx lib (already used) -->
<script src="https://cdn.jsdelivr.net/npm/docx@8.3.2/build/index.js"></script>
<!-- FileSaver to trigger download in browsers (including iOS fallback) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
    function ajouterColonne() {
        const table = document.getElementById("grid");

        // Ligne des numéros (2e ligne du thead)
        const theadRows = table.querySelectorAll("thead tr");
        const numerosRow = theadRows[1];
        const newIndex = numerosRow.cells.length + 1; // numéro suivant

        // Ajouter le numéro dans la 2e ligne
        const th = document.createElement("th");
        th.textContent = newIndex;
        numerosRow.appendChild(th);

        // Ajouter une case par ligne du tbody
        table.querySelectorAll("tbody tr").forEach(tr => {
            const td = document.createElement("td");
            const cb = document.createElement("input");
            cb.type = "checkbox";
            td.appendChild(cb);
            tr.appendChild(td);
        });

        // Ajuster le colspan de "Numéro de la charge" (1ère ligne)
        const firstRow = theadRows[0];
        const colspanCell = firstRow.querySelector("th[colspan]");
        colspanCell.colSpan = numerosRow.cells.length;
    }

    function supprimerColonne() {
        const table = document.getElementById("grid");

        const theadRows = table.querySelectorAll("thead tr");
        const numerosRow = theadRows[1];

        if (numerosRow.cells.length > 1) {
            // Supprimer le dernier numéro
            numerosRow.removeChild(numerosRow.lastElementChild);

            // Supprimer la dernière cellule de chaque ligne du tbody
            table.querySelectorAll("tbody tr").forEach(tr => {
                tr.removeChild(tr.lastElementChild);
            });

            // Ajuster le colspan
            const firstRow = theadRows[0];
            const colspanCell = firstRow.querySelector("th[colspan]");
            colspanCell.colSpan = numerosRow.cells.length;
        }
    }

    // Persistance locale
    document.addEventListener('DOMContentLoaded', () => {
        // --- Date triplet auto-advance & validation ---
        const y = document.getElementById('dateY');
        const m = document.getElementById('dateM');
        const d = document.getElementById('dateD');

        function onlyDigits(el){ el.value = el.value.replace(/\D+/g,''); }
        function clamp(n, min, max){ n = Number(n); if (isNaN(n)) return null; return Math.min(Math.max(n, min), max); }
        function daysInMonth(year, month){ return new Date(year, month, 0).getDate(); }
        function pad2(v){ return String(v).padStart(2,'0'); }

        function updateCombined(){
            if (y.value.length===4 && m.value.length>=1 && d.value.length>=1){
                const yy = y.value;
                const mm = pad2(m.value);
                const dd = pad2(d.value);
                const combined = `${yy}/${mm}/${dd}`;
                localStorage.setItem('st_date', combined);
            }
        }

        // Initialize from storage
        (function initTriplet(){
            const saved = localStorage.getItem('st_date');
            const mRe = /^(\d{4})\/(\d{2})\/(\d{2})$/;
            if (saved && mRe.test(saved)){
                const match = saved.match(mRe);
                y.value = match[1]; m.value = match[2]; d.value = match[3];
            }
        })();

        // Input behavior
        y.addEventListener('input', ()=>{ onlyDigits(y); if (y.value.length>=4) m.focus(); updateCombined(); });
        m.addEventListener('input', ()=>{ onlyDigits(m); if (m.value.length>=2) d.focus(); updateCombined(); });
        d.addEventListener('input', ()=>{ onlyDigits(d); updateCombined(); });

        m.addEventListener('keydown', (e)=>{ if (e.key==='Backspace' && m.value.length===0) y.focus(); });
        d.addEventListener('keydown', (e)=>{ if (e.key==='Backspace' && d.value.length===0) m.focus(); });

        m.addEventListener('blur', ()=>{
            if (!m.value) return;
            let mm = clamp(m.value,1,12);
            if (mm) m.value = pad2(mm);
            updateCombined();
        });
        d.addEventListener('blur', ()=>{
            if (!d.value) return;
            let yy = parseInt(y.value,10);
            let mm = parseInt(m.value,10);
            if (!yy || !mm) return;
            const maxD = daysInMonth(yy, mm);
            let dd = clamp(d.value,1,maxD);
            if (dd) d.value = pad2(dd);
            updateCombined();
        });

        const dateInput = document.getElementById('date');
        const codeInput = document.getElementById('code');
        const q1 = document.getElementById('q1');

        dateInput.value = localStorage.getItem('st_date') || '';
        codeInput.value = localStorage.getItem('st_code') || '';
        q1.value = localStorage.getItem('st_q1') || '';

        dateInput.addEventListener('input', () => localStorage.setItem('st_date', dateInput.value));
        codeInput.addEventListener('input', () => localStorage.setItem('st_code', codeInput.value));
        q1.addEventListener('input', () => localStorage.setItem('st_q1', q1.value));

        const checkboxes = document.querySelectorAll("table input[type=checkbox]");
        checkboxes.forEach((box, i) => {
            if (localStorage.getItem("checkbox" + i) === "true") box.checked = true;
            box.addEventListener("change", () => localStorage.setItem("checkbox" + i, box.checked));
        });
    });

    // Génération Word

    function resetSterilForm(){
        try {
            const form = document.getElementById('steri-form');
            // Clear checkboxes localStorage and uncheck
            const cbs = document.querySelectorAll("table input[type=checkbox]");
            cbs.forEach((cb, i) => { localStorage.removeItem("checkbox"+i); cb.checked = false; });

            function clearFormAndStorage() {
                const form = document.getElementById('steri-form');
                if (form) form.reset();
                localStorage.clear();
            }

            // Clear date triplet
            const yEl = document.getElementById('dateY');
            const mEl = document.getElementById('dateM');
            const dEl = document.getElementById('dateD');
            if (yEl) yEl.value = '';
            if (mEl) mEl.value = '';
            if (dEl) dEl.value = '';

            // Clear code + question
            const codeEl = document.getElementById('code');
            const q1El = document.getElementById('q1');
            if (codeEl) codeEl.value = '';
            if (q1El) q1El.value = '';

            // Clear storage
            localStorage.removeItem('st_date');
            localStorage.removeItem('st_code');
            localStorage.removeItem('st_q1');

            // As a fallback, reset the form
            if (form && form.reset) form.reset();

            // Toast
            const toast = document.createElement('div');
            toast.textContent = 'Fiche soumise. Le formulaire a été réinitialisé.';
            toast.style.cssText='position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0f1c3f;color:#e7eeff;border:1px solid rgba(255,255,255,.2);padding:10px 14px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.3);z-index:9999';
            document.body.appendChild(toast);
            setTimeout(()=>toast.remove(), 2200);
            window.scrollTo({top:0, behavior:"smooth"});
        } catch(e) {}
    }


    function askPdfThenReset(){
        const yes = confirm('Voulez-vous aussi télécharger en PDF ?');
        if (yes){
            let didAfterprint = false;
            const handler = () => { didAfterprint = true; resetSterilForm(); };
            window.addEventListener('afterprint', handler, { once:true });
            // Fallback timeout in case 'afterprint' doesn't fire (some iOS versions)
            setTimeout(()=>{ if (!didAfterprint) resetSterilForm(); }, 8000);
            window.print();
        } else {
            resetSterilForm();
        }
    }

    document.getElementById('steri-form').addEventListener('submit', async function (e) {
        e.preventDefault();

        // Collect same data as before
        const date = `${document.getElementById('dateY').value}/${(document.getElementById('dateM').value||'').toString().padStart(2,'0')}/${(document.getElementById('dateD').value||'').toString().padStart(2,'0')}`;
        const code = (document.getElementById('code').value || '').trim();
        const now = new Date();
        const heure = String(now.getHours()).padStart(2,'0') + "h" + String(now.getMinutes()).padStart(2,'0');

        const table = document.getElementById('grid');
        const rowLabels = [];
        const checks = [];
        const tbodyRows = table.tBodies[0].rows;
        for (let r = 0; r < tbodyRows.length; r++) {
            const tr = tbodyRows[r];
            rowLabels.push(tr.cells[0].innerText.trim());
            const rowVals = [];
            // adapt to current number of columns (dynamic)
            for (let c = 1; c < tr.cells.length; c++) {
                const cb = tr.cells[c].querySelector('input[type=checkbox]');
                rowVals.push(!!(cb && cb.checked));
            }
            checks.push(rowVals);
        }

        const qItems = [];
        document.querySelectorAll('.questionbox, textarea[id^="question-"]').forEach(area => {
            const label = (area.previousElementSibling?.textContent || 'Question').trim();
            qItems.push({ label, value: area.value || '' });
        });

        // Build a real docx using docx.js
        try {
            const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, HeadingLevel } = docx;

            // Build header paragraphs
            const headerPara = new Paragraph({
                children: [ new TextRun({ text: "Registre du stérilisateur", bold: true, size: 28 }) ],
            });

            const metaPara = new Paragraph({
                children: [
                    new TextRun({ text: `Date : ${date}    ` }),
                    new TextRun({ text: `Heure : ${heure}    ` }),
                    new TextRun({ text: `Code : ${code}` })
                ]
            });

            // Build table header
            const cols = checks[0] ? checks[0].length : 0;
            const headerCells = [];
            headerCells.push(new TableCell({ children: [ new Paragraph({ children: [ new TextRun({ text: "Paramètres", bold: true }) ] }) ] }));
            for (let i = 0; i < cols; i++) {
                headerCells.push(new TableCell({ children: [ new Paragraph({ children: [ new TextRun({ text: String(i+1), bold: true }) ] }) ] }));
            }
            const headerRow = new TableRow({ children: headerCells });

            // Build table body rows
            const bodyRows = [];
            for (let r = 0; r < rowLabels.length; r++) {
                const cells = [];
                // label cell
                cells.push(new TableCell({
                    children: [ new Paragraph({ children: [ new TextRun({ text: rowLabels[r], bold: true }) ] }) ]
                }));
                // checkbox results cells
                for (let c = 0; c < cols; c++) {
                    const val = checks[r][c];
                    const symbol = val ? '✔' : '—';
                    cells.push(new TableCell({
                        children: [ new Paragraph({ children: [ new TextRun({ text: symbol }) ] }) ],
                    }));
                }
                bodyRows.push(new TableRow({ children: cells }));
            }

            const tableDoc = new Table({
                rows: [ headerRow, ...bodyRows ],
                width: {
                    size: 100,
                    type: "pct"
                }
            });

            // Questions section as table
            const qRows = [];
            for (let i = 0; i < qItems.length; i++) {
                const q = qItems[i];
                qRows.push(new TableRow({
                    children: [
                        new TableCell({ children: [ new Paragraph({ children: [ new TextRun({ text: q.label, bold: true }) ] }) ], width: { size: 40, type: "pct" } }),
                        new TableCell({ children: [ new Paragraph({ children: [ new TextRun({ text: q.value || '' }) ] }) ], width: { size: 60, type: "pct" } })
                    ]
                }));
            }
            let qTable = null;
            if (qRows.length) {
                qTable = new Table({
                    rows: qRows,
                    width: { size: 100, type: "pct" }
                });
            }

            // Build the document
            const doc = new Document({
                sections: [
                    {
                        properties: {},
                        children: [
                            headerPara,
                            metaPara,
                            new Paragraph({ text: "" }),
                            tableDoc,
                            new Paragraph({ text: "" }),
                            ...(qTable ? [ new Paragraph({ text: "Questions complémentaires", heading: HeadingLevel.HEADING_1 }), qTable ] : [])
                        ]
                    }
                ]
            });

            // Pack to blob and save
            const blob = await Packer.toBlob(doc);
            const filename = `${(date||'XXXX-XX-XX')}-${heure}-${(code||'CODE')}.docx`;

            // Use FileSaver to save
            if (typeof saveAs === 'function') {
                saveAs(blob, filename);
                // after saving, call reset flow
                askPdfThenReset();
            } else {
                // fallback: create object URL
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); askPdfThenReset(); }, 250);
            }
        } catch (err) {
            console.error("Erreur lors de la création du DOCX :", err);
            // If docx fails, fallback to previous HTML .doc (older method)
            try {
                const styleTable = 'border-collapse:collapse;width:100%';
                const styleTh = 'border:1px solid #999;padding:6px;background:#dde7f6;text-align:center;font-weight:bold';
                const styleTd = 'border:1px solid #999;padding:6px;text-align:center';
                const styleTdLeft = 'border:1px solid #999;padding:6px;text-align:left;font-weight:bold;background:#f4f6f8';

                const headerHTML = `\n      <h1 style="font-family:Arial,sans-serif;">Registre du stérilisateur</h1>\n      <p><strong>Date :</strong> ${escapeHtml(date)} |\n         <strong>Heure :</strong> ${heure} |\n         <strong>Code :</strong> ${escapeHtml(code)}</p>`;

                let gridHTML = `<table style="${styleTable}">\n      <thead><tr>\n        <th style="${styleTh}" rowspan="2">Paramètres</th>\n        <th style="${styleTh}" colspan="${checks[0].length}">Numéro de la charge</th>\n      </tr><tr>\n        ${Array.from({length:checks[0].length}, (_,i)=>`<th style="${styleTh}">${i+1}</th>`).join('')}\n      </tr></thead><tbody>`;

                for (let r = 0; r < rowLabels.length; r++) {
                    gridHTML += `<tr>\n        <td style="${styleTdLeft}">${escapeHtml(rowLabels[r])}</td>\n        ${checks[r].map(v => `<td style="${styleTd}">${v ? '✔️' : '—'}</td>`).join('')}\n      </tr>`;
                }
                gridHTML += `</tbody></table>`;

                let questionsHTML = '';
                if (qItems.length) {
                    questionsHTML = `<h2>Questions complémentaires</h2><table style="${styleTable}"><tbody>` +
                        qItems.map(q => `<tr>\n          <td style="${styleTdLeft};width:40%">${escapeHtml(q.label)}</td>\n          <td style="${styleTd};text-align:left;white-space:pre-wrap">${escapeHtml(q.value)}</td>\n        </tr>`).join('') + `</tbody></table>`;
                }

                const docHTML = `\n      <html xmlns:o="urn:schemas-microsoft-com:office:office"\n            xmlns:w="urn:schemas-microsoft-com:office:word">\n      <head><meta charset="UTF-8"></head>\n      <body>${headerHTML}${gridHTML}${questionsHTML}</body></html>`;

                const mime = 'application/msword';
                const filename = `${(date||'XXXX-XX-XX')}-${heure}-${(code||'CODE')}.doc`;
                const blob = new Blob(['\ufeff', docHTML], { type: mime });

                // Try best methods for iPad / iPhone / desktop
                try {
                    // 1) If Web Share API with files supported (best on iOS Safari)
                    if (navigator.canShare && navigator.canShare({ files: [new File([blob], filename, { type: mime })] })) {
                        const file = new File([blob], filename, { type: mime });
                        await navigator.share({ files: [file], title: filename });
                        // after successful share, ask for PDF and reset
                        askPdfThenReset();
                        return;
                    }
                } catch (err) {
                    // continue to fallback
                }

                // 2) Fallback: create object URL and open in new tab/window — on iPad user can long-press to "Enregistrer dans Fichiers" or "Ouvrir dans..."
                try {
                    const url = URL.createObjectURL(blob);
                    const w = window.open(url, '_blank');
                    if (w) {
                        // Opened in new tab — schedule revoke
                        setTimeout(() => { URL.revokeObjectURL(url); askPdfThenReset(); }, 300);
                        return;
                    }
                } catch (err) {
                    // continue
                }

                // 3) Older fallback: use anchor download if supported (some browsers on iPad don't honor it)
                if ('download' in HTMLAnchorElement.prototype) {
                    const a = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => { URL.revokeObjectURL(url); a.remove(); askPdfThenReset(); }, 150);
                    return;
                }

                // 4) Last resort: open data URL
                const reader = new FileReader();
                reader.onloadend = function() {
                    window.open(reader.result, '_blank');
                    askPdfThenReset();
                };
                reader.readAsDataURL(blob);

            } catch (e2) {
                console.error("Fallback also failed", e2);
                alert("Impossible de générer le document (erreur).");
            }
        }

    });

    function escapeHtml(s){
        return (s||'').replace(/&/g,'&amp;')
            .replace(/</g,'&lt;')
            .replace(/>/g,'&gt;')
            .replace(/"/g,'&quot;');
    }
</script>
<script src="app.js"></script>
</body>
</html>
